---
title: "Routine structural missing data diagnostics"
author: "Janick Weberpals"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Routine structural missing data diagnostics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 150,
  fig.width = 6,
  fig.height = 4.5
  )
```

```{r setup}
library(smdi)
suppressPackageStartupMessages(library(dplyr))
```

# `smdi` main functionalities

The `smdi` flagship function is `smdi_diagnose()` which calls multiple sub-functions which are also accessible separately. `smdi_diagnose()` builds on theoretical concepts developed and validated in a comprehensive simulation study as part of the FDA Sentinel Innovation Center workstream [Approaches to Handling Partially Observed Confounder Data From Electronic Health Records (EHR) In Non-randomized Studies of Medication Outcomes](https://www.sentinelinitiative.org/methods-data-tools/methods/approaches-handling-partially-observed-confounder-data-electronic-health).

For details, we refer to *[INSERT REFERENCE ONCE PUBLISHED]* and *[INSERT JSS REFERENCE ONCE PUBLISHED]*.

In brief, `smdi_diagnose()` compute three group diagnostics.

```{r, echo = FALSE}
knitr::include_graphics(here::here("vignettes", "smdi_diagnose_table.png"))
```

## Illustrative dataset

To illustrate the usage of the `smdi` package main functions, we use the `smdi_data` dataset which is an example dataset that comes bundled with the package. In brief, the `smdi_data` dataset consists of a simulated lung cancer cohort with a fictional comparison of two antineoplastic systemic therapy regimens and a time-to-event outcome. More information on the underlying dataset is given in the previous [Data generation](https://janickweberpals.gitlab-pages.partners.org/smdi/articles/data_generation.html) article.

```{r}
smdi::smdi_data %>% 
  dplyr::glimpse()
```

The dataset consists of `r formatC(nrow(smdi_data), format = "fg", big.mark = ",")` patients and `r ncol(smdi_data)` variables with `exposure` representing the two treatment regimens under comparison and `status` and `eventtime` the vital status and censoring time, respectively. For more information, please checkout:

```{r, eval=FALSE}
# dataset with simulated missingness
?smdi::smdi_data()

# complete dataset
?smdi::smdi_data_complete()
```


## Descriptives

As with basically any first step into exploring (new) datasets, it's a good idea to get an overview of partially observed covariates and the magnitude of missingness. For this `smdi` comes with two convenient functions to screen the data for missingness.

This can be either as a table ...

```{r}
smdi_data %>% 
  smdi_summarize()
```

... or visually

```{r}
covars_missing <- smdi_summarize(data = smdi_data) %>% 
  pull(covariate)

smdi_data %>% 
  smdi_vis(covar = covars_missing)
```

For `smdi_vis`, it's also possible to query the **top n** missing covariates in a dataset:

```{r}
smdi_data %>% 
  smdi_vis(top_n_covar = 3)
```


## Group 1 diagnostics: differences in covariate distributions

### Median/average absolute standardized mean differences

>Cite STRATOS paper

```{r}
amsd <- smdi_asmd(data = smdi_data)
amsd
```

```{r}
summary(amsd)
```

```{r}
amsd$egfr_cat$asmd_table1
```

```{r}
amsd$egfr_cat$asmd_plot
```

### Hotelling's and Little's hypothesis tests

```{r}
h0 <- smdi_hotelling(data = smdi_data)
h0
```

```{r}
h0$ecog_cat
```

Little's global

```{r}
h0_global <- smdi_little(data = smdi_data)
h0_global
```

## Group 2 diagnostics: ability to predict missingness

```{r}
auc <- smdi_rf(data = smdi_data)
auc
```

